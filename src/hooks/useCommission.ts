import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { supabase } from '@/integrations/supabase/client';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { startOfWeek, getWeek, startOfMonth, endOfMonth } from 'date-fns';\n\nexport type PeriodWeek = 'M1' | 'M2' | 'M3' | 'M4' | 'M5';\n\nexport interface CommissionForm {\n  account_id: string;\n  period_week: PeriodWeek;\n  period_month: number;\n  period_year: number;\n  commission_date: string; // yyyy-mm-dd\n  gross_commission: number;\n  net_commission: number;\n  disbursed_commission: number;\n  disbursement_date?: string; // yyyy-mm-dd\n  commission_rate?: number;\n  notes?: string;\n}\n\nexport interface CommissionSummary {\n  totalGross: number;\n  totalNet: number;\n  totalDisbursed: number;\n  totalPending: number;\n  count: number;\n}\n\n// Helper: Calculate period week from date\nexport const calculatePeriodWeek = (date: Date): PeriodWeek => {\n  const monthStart = startOfMonth(date);\n  const weekOfMonth = Math.ceil(date.getDate() / 7);\n  \n  // M1-M5 mapping based on week of month\n  if (weekOfMonth <= 1) return 'M1';\n  if (weekOfMonth <= 2) return 'M2';\n  if (weekOfMonth <= 3) return 'M3';\n  if (weekOfMonth <= 4) return 'M4';\n  return 'M5';\n};\n\nexport const useCommissionData = (year: number, month: number, filters?: {\n  groupId?: string;\n  accountId?: string;\n  employeeId?: string;\n}) => {\n  const { user } = useAuth();\n  \n  const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0];\n  const endDate = new Date(year, month, 0).toISOString().split('T')[0];\n\n  return useQuery({\n    queryKey: ['commissions', year, month, filters, user?.id],\n    queryFn: async () => {\n      let query = supabase\n        .from('commissions')\n        .select(`\n          *,\n          accounts(id, username, platform, email),\n          profiles!commissions_employee_id_fkey(full_name, role),\n          groups(name)\n        `)\n        .gte('commission_date', startDate)\n        .lte('commission_date', endDate)\n        .order('commission_date', { ascending: false })\n        .order('period_week', { ascending: true });\n\n      if (filters?.groupId) {\n        query = query.eq('group_id', filters.groupId);\n      }\n      if (filters?.accountId) {\n        query = query.eq('account_id', filters.accountId);\n      }\n      if (filters?.employeeId) {\n        query = query.eq('employee_id', filters.employeeId);\n      }\n\n      const { data, error } = await query;\n      if (error) throw error;\n      \n      return data || [];\n    },\n    enabled: !!user && !!year && !!month,\n    staleTime: 2 * 60 * 1000, // 2 minutes\n  });\n};\n\nexport const useCommissionSummary = (year: number, month: number, filters?: {\n  groupId?: string;\n  accountId?: string;\n  employeeId?: string;\n}) => {\n  const commissionQuery = useCommissionData(year, month, filters);\n  \n  const summary: CommissionSummary = {\n    totalGross: 0,\n    totalNet: 0, \n    totalDisbursed: 0,\n    totalPending: 0,\n    count: 0\n  };\n\n  if (commissionQuery.data) {\n    const data = commissionQuery.data;\n    summary.count = data.length;\n    summary.totalGross = data.reduce((sum, c) => sum + (c.gross_commission || 0), 0);\n    summary.totalNet = data.reduce((sum, c) => sum + (c.net_commission || 0), 0);\n    summary.totalDisbursed = data.reduce((sum, c) => sum + (c.disbursed_commission || 0), 0);\n    summary.totalPending = summary.totalNet - summary.totalDisbursed;\n  }\n\n  return {\n    ...commissionQuery,\n    data: summary\n  };\n};\n\nexport const useCreateCommission = () => {\n  const qc = useQueryClient();\n  const { user } = useAuth();\n\n  return useMutation({\n    mutationFn: async (payload: CommissionForm) => {\n      if (!user) throw new Error('User belum login');\n\n      const { data, error } = await supabase\n        .from('commissions')\n        .insert({\n          account_id: payload.account_id,\n          period_week: payload.period_week,\n          period_month: payload.period_month,\n          period_year: payload.period_year,\n          commission_date: payload.commission_date,\n          gross_commission: payload.gross_commission,\n          net_commission: payload.net_commission,\n          disbursed_commission: payload.disbursed_commission,\n          disbursement_date: payload.disbursement_date,\n          commission_rate: payload.commission_rate,\n          notes: payload.notes,\n          employee_id: user.id,\n          group_id: user.profile?.group_id,\n          created_by: user.id,\n        })\n        .select('*')\n        .single();\n\n      if (error) throw error;\n      return data;\n    },\n    onSuccess: () => {\n      qc.invalidateQueries({ queryKey: ['commissions'] });\n      qc.invalidateQueries({ queryKey: ['dashboard-metrics'] });\n    }\n  });\n};\n\nexport const useUpdateCommission = () => {\n  const qc = useQueryClient();\n\n  return useMutation({\n    mutationFn: async ({ id, payload }: { id: string; payload: Partial<CommissionForm> }) => {\n      const { data, error } = await supabase\n        .from('commissions')\n        .update({\n          ...payload,\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', id)\n        .select('*')\n        .single();\n\n      if (error) throw error;\n      return data;\n    },\n    onSuccess: () => {\n      qc.invalidateQueries({ queryKey: ['commissions'] });\n      qc.invalidateQueries({ queryKey: ['dashboard-metrics'] });\n    }\n  });\n};\n\nexport const useDeleteCommission = () => {\n  const qc = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (id: string) => {\n      const { error } = await supabase\n        .from('commissions')\n        .delete()\n        .eq('id', id);\n\n      if (error) throw error;\n    },\n    onSuccess: () => {\n      qc.invalidateQueries({ queryKey: ['commissions'] });\n      qc.invalidateQueries({ queryKey: ['dashboard-metrics'] });\n    }\n  });\n};\n